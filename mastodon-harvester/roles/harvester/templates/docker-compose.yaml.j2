version: "3.8"

services:
{% for item in mastodon_servers %}
  mastodon-harvester-{{item.server_name}}:
    image: mastodon_harvester
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.type == app
    command: ["python", "matdn.py", "--mastodon_server_url", "{{ item.server_url }}", "--mastodon_access_token", "{{ item.access_token }}", "--couchdb_endpoint", "{{ couchdb_endpoint }}", "--couchdb_database", "{{ couchdb_database }}", "--mastodon_server_tag", "{{ item.server_name }}"]
    networks:
      - mastodon-harvester
{% endfor %}
networks:
  mastodon-harvester:
    driver: overlay